{% extends "base.html" %}
{% load crispy_forms_tags %}

{% block title %}Create Leave Request{% endblock %}

{% block extra_css %}
<style>
    .conflict-warning {
        border: 1px solid #ffc107;
        background-color: #fff3cd;
        border-radius: 0.375rem;
        padding: 1rem;
        margin-top: 1rem;
    }
    
    .conflict-shifts {
        max-height: 200px;
        overflow-y: auto;
    }
    
    .suggested-employees {
        max-height: 150px;
        overflow-y: auto;
    }
    
    .form-section {
        margin-bottom: 2rem;
    }
    
    .help-text {
        font-size: 0.875rem;
        color: #6c757d;
        margin-top: 0.25rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h3 class="mb-0">
                        <i class="fas fa-calendar-plus me-2"></i>
                        Create Leave Request
                    </h3>
                    <p class="text-muted mb-0">Submit a new leave request for approval</p>
                </div>
                <div class="card-body">
                    <!-- Instructions -->
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle me-1"></i> Instructions</h6>
                        <ul class="mb-0 small">
                            <li>Select your leave type and dates carefully</li>
                            <li>Provide a clear reason for your leave request</li>
                            <li>Check for shift conflicts that may need to be resolved</li>
                            <li>Your request will be reviewed by management</li>
                        </ul>
                    </div>
                    
                    <form method="post" id="leave-request-form">
                        {% csrf_token %}
                        
                        <div class="form-section">
                            <h5 class="border-bottom pb-2 mb-3">Leave Details</h5>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    {{ form.leave_type|crispy }}
                                </div>
                                <div class="col-md-6 mb-3">
                                    {{ form.days_requested|crispy }}
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    {{ form.start_date|crispy }}
                                </div>
                                <div class="col-md-6 mb-3">
                                    {{ form.end_date|crispy }}
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                {{ form.reason|crispy }}
                            </div>
                        </div>
                        
                        <!-- Conflict Check Section -->
                        <div class="form-section">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="fas fa-exclamation-triangle me-1"></i>
                                Shift Conflict Check
                            </h5>
                            
                            <div id="conflict-check-container">
                                <div class="alert alert-secondary">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Select dates above to check for shift conflicts.
                                </div>
                            </div>
                            
                            <button type="button" id="check-conflicts-btn" class="btn btn-outline-warning" disabled>
                                <i class="fas fa-search me-1"></i>
                                Check for Conflicts
                            </button>
                        </div>
                        
                        <!-- Form Actions -->
                        <div class="form-actions d-flex justify-content-between">
                            <a href="{% url 'leaves:leave_request_list' %}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left me-1"></i>
                                Cancel
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-paper-plane me-1"></i>
                                Submit Request
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Conflict Details Modal -->
<div class="modal fade" id="conflictModal" tabindex="-1" aria-labelledby="conflictModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="conflictModalLabel">
                    <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                    Shift Conflicts Detected
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="conflict-details"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-warning" id="proceed-anyway-btn">
                    Proceed Anyway
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const startDateField = document.getElementById('id_start_date');
    const endDateField = document.getElementById('id_end_date');
    const checkConflictsBtn = document.getElementById('check-conflicts-btn');
    const conflictContainer = document.getElementById('conflict-check-container');
    const form = document.getElementById('leave-request-form');
    const submitBtn = form.querySelector('button[type="submit"]');
    
    let hasConflicts = false;
    let conflictsChecked = false;
    
    // Auto-calculate days when dates change
    function calculateDays() {
        const startDate = startDateField.value;
        const endDate = endDateField.value;
        const daysField = document.getElementById('id_days_requested');
        
        if (startDate && endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            
            if (end >= start) {
                const diffTime = Math.abs(end - start);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                daysField.value = diffDays;
                
                // Enable conflict check
                checkConflictsBtn.disabled = false;
                conflictsChecked = false;
                
                // Reset conflict status
                updateConflictStatus('info', 'Select "Check for Conflicts" to verify no shifts are affected.');
            }
        } else {
            checkConflictsBtn.disabled = true;
            conflictsChecked = false;
        }
    }
    
    // Update conflict check container
    function updateConflictStatus(type, message) {
        const alertClass = type === 'info' ? 'alert-secondary' : 
                          type === 'warning' ? 'alert-warning' : 
                          type === 'success' ? 'alert-success' : 'alert-danger';
        
        const icon = type === 'info' ? 'info-circle' : 
                    type === 'warning' ? 'exclamation-triangle' : 
                    type === 'success' ? 'check-circle' : 'times-circle';
        
        conflictContainer.innerHTML = `
            <div class="alert ${alertClass}">
                <i class="fas fa-${icon} me-1"></i>
                ${message}
            </div>
        `;
    }
    
    // Check for conflicts via AJAX
    function checkConflicts() {
        const startDate = startDateField.value;
        const endDate = endDateField.value;
        
        if (!startDate || !endDate) {
            return;
        }
        
        checkConflictsBtn.disabled = true;
        checkConflictsBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Checking...';
        
        fetch(`{% url 'leaves:check_conflicts_ajax' %}?start_date=${startDate}&end_date=${endDate}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    updateConflictStatus('danger', data.error);
                } else if (data.conflicts && data.conflicts.length > 0) {
                    hasConflicts = true;
                    showConflictDetails(data.conflicts, data.suggested_employees);
                    updateConflictStatus('warning', 
                        `${data.conflicts.length} shift conflict(s) detected. Review conflicts before submitting.`
                    );
                } else {
                    hasConflicts = false;
                    updateConflictStatus('success', 'No shift conflicts detected. Your request can proceed.');
                }
                
                conflictsChecked = true;
                checkConflictsBtn.disabled = false;
                checkConflictsBtn.innerHTML = '<i class="fas fa-search me-1"></i> Re-check Conflicts';
            })
            .catch(error => {
                console.error('Error checking conflicts:', error);
                updateConflictStatus('danger', 'Error checking for conflicts. Please try again.');
                checkConflictsBtn.disabled = false;
                checkConflictsBtn.innerHTML = '<i class="fas fa-search me-1"></i> Check for Conflicts';
            });
    }
    
    // Show conflict details in modal
    function showConflictDetails(conflicts, suggestedEmployees) {
        let conflictHtml = '<h6>Conflicting Shifts:</h6><div class="conflict-shifts">';
        
        conflicts.forEach(conflict => {
            const startDate = new Date(conflict.start_date).toLocaleDateString();
            const startTime = new Date(conflict.start_date).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            const endTime = new Date(conflict.end_date).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            conflictHtml += `
                <div class="border rounded p-2 mb-2">
                    <strong>${conflict.shift_type}</strong><br>
                    <small class="text-muted">${startDate} ${startTime} - ${endTime}</small>
                    ${conflict.can_create_swap ? 
                        '<span class="badge bg-info ms-2">Swap Available</span>' : 
                        '<span class="badge bg-warning ms-2">Manual Resolution Required</span>'
                    }
                </div>
            `;
        });
        
        conflictHtml += '</div>';
        
        if (suggestedEmployees && suggestedEmployees.length > 0) {
            conflictHtml += '<h6 class="mt-3">Suggested Employees for Coverage:</h6><div class="suggested-employees">';
            suggestedEmployees.forEach(emp => {
                conflictHtml += `
                    <div class="border rounded p-2 mb-1">
                        <strong>${emp.name}</strong> - ${emp.role || 'Employee'}
                    </div>
                `;
            });
            conflictHtml += '</div>';
        }
        
        conflictHtml += `
            <div class="alert alert-info mt-3">
                <strong>Note:</strong> You can still submit this leave request, but conflicts must be resolved 
                before approval. Consider creating shift swap requests for conflicting shifts.
            </div>
        `;
        
        document.getElementById('conflict-details').innerHTML = conflictHtml;
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('conflictModal'));
        modal.show();
    }
    
    // Form submission validation
    form.addEventListener('submit', function(e) {
        if (!conflictsChecked) {
            e.preventDefault();
            alert('Please check for shift conflicts before submitting your leave request.');
            return false;
        }
        
        if (hasConflicts) {
            const proceed = confirm(
                'Your leave request has shift conflicts that need to be resolved. ' +
                'Do you want to submit anyway? (Conflicts must be resolved before approval)'
            );
            
            if (!proceed) {
                e.preventDefault();
                return false;
            }
        }
        
        // Add loading state
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Submitting...';
    });
    
    // Event listeners
    startDateField.addEventListener('change', calculateDays);
    endDateField.addEventListener('change', calculateDays);
    checkConflictsBtn.addEventListener('click', checkConflicts);
    
    // Proceed anyway button in modal
    document.getElementById('proceed-anyway-btn').addEventListener('click', function() {
        const modal = bootstrap.Modal.getInstance(document.getElementById('conflictModal'));
        modal.hide();
        updateConflictStatus('warning', 
            'Conflicts acknowledged. You may proceed, but conflicts must be resolved before approval.'
        );
    });
    
    // Initialize
    calculateDays();
});
</script>
{% endblock %}
